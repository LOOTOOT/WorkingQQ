<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>付QQ的最终幻想</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts (Noto Sans SC for Chinese) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FFFBF8',
                            accent: '#FFCCB6',
                            highlight: '#D8F878',
                            dark: '#1D1D1F', // Apple Text Black
                            gray: '#86868b' // Apple Text Gray
                        },
                        wx: {
                            green: '#95EC69',
                            bg: '#F5F5F5'
                        }
                    },
                    fontFamily: {
                        sans: ['"SF Pro Display"', '"SF Pro Text"', '"Helvetica Neue"', 'Helvetica', 'Arial', '"Noto Sans SC"', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'fade-out': 'fadeOut 0.5s ease-out forwards',
                        'breath': 'breath 3s infinite ease-in-out',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'ripple': 'ripple 1s linear forwards',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        fadeOut: { '0%': { opacity: '1' }, '100%': { opacity: '0' } },
                        breath: { '0%, 100%': { opacity: '1', transform: 'scale(1)' }, '50%': { opacity: '0.7', transform: 'scale(1.02)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        pop: { '0%': { transform: 'scale(0.9)', opacity: '0' }, '100%': { transform: 'scale(1)', opacity: '1' } },
                        ripple: { '0%': { transform: 'scale(0)', opacity: '1' }, '100%': { transform: 'scale(4)', opacity: '0' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFFBF8;
            /* 柔和的渐变背景 */
            background-image: radial-gradient(circle at 10% 20%, rgba(255, 204, 182, 0.2) 0%, rgba(255, 251, 248, 0) 50%),
                              radial-gradient(circle at 90% 80%, rgba(216, 248, 120, 0.15) 0%, rgba(255, 251, 248, 0) 50%);
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }

        /* 隐藏滚动条但允许滚动 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 玻璃拟态卡片 */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.05);
        }

        /* 微信气泡 */
        .chat-bubble {
            max-width: 75%;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.4;
            position: relative;
            word-wrap: break-word;
        }
        .chat-me {
            background-color: #95EC69;
            color: #000;
            margin-left: auto;
        }
        .chat-me::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 10px;
            width: 0;
            height: 0;
            border-left: 6px solid #95EC69;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }
        .chat-other {
            background-color: #FFFFFF;
            color: #000;
            margin-right: auto;
            border: 1px solid #E5E5E5;
        }
        .chat-other::after {
            content: '';
            position: absolute;
            left: -6px;
            top: 10px;
            width: 0;
            height: 0;
            border-right: 6px solid #FFFFFF;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
        }

        /* 粒子消散文字特效 */
        .text-dissolve-leave-active {
            transition: all 0.8s ease;
        }
        .text-dissolve-leave-to {
            opacity: 0;
            transform: scale(1.5);
            filter: blur(10px);
            letter-spacing: 10px;
        }

        .fade-enter-active, .fade-leave-active {
            transition: opacity 0.5s ease;
        }
        .fade-enter-from, .fade-leave-to {
            opacity: 0;
        }

        /* 手机优化 */
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom);
        }
    </style>
</head>
<body class="text-brand-dark h-screen w-screen overflow-hidden selection:bg-brand-highlight selection:text-brand-dark">

    <div id="app" class="h-full w-full relative">

        <!-- 背景音乐 -->
        <audio ref="bgm" loop>
            <source :src="assets.bgm" type="audio/mpeg">
        </audio>

        <!-- 1. 登录页面 (Login) -->
        <transition name="fade">
            <div v-if="currentView === 'login'" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-brand-bg">
                <div v-if="loginTextShow" class="text-2xl font-light tracking-widest mb-12 animate-breath text-brand-gray">
                    请登录
                </div>

                <div class="relative group cursor-pointer" @click="handleLogin">
                    <!-- 头像 -->
                    <div class="w-32 h-32 rounded-full overflow-hidden shadow-2xl transition-all duration-300 transform group-hover:scale-110 border-4 border-white relative z-10 glass-card">
                        <img :src="assets.avatar" alt="Avatar" class="w-full h-full object-cover">
                    </div>
                    <!-- 波纹动画容器 -->
                    <div v-if="isLoggingIn" class="absolute inset-0 rounded-full border-2 border-brand-accent animate-ripple z-0"></div>
                </div>

                <div v-if="loginSuccessInfo" class="mt-8 text-xl font-medium text-brand-dark animate-fade-in">
                    登入成功
                </div>
            </div>
        </transition>

        <!-- 2. 游戏主页 (Main Menu) -->
        <transition name="fade">
            <div v-if="currentView === 'main'" class="absolute inset-0 z-40 bg-black" @click="startGame">
                <img :src="assets.mainPage" class="w-full h-full object-cover opacity-90" alt="Main Page">
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="glass-card px-8 py-4 rounded-full animate-breath">
                        <p class="text-sm font-bold tracking-widest uppercase text-brand-dark">点击任意地方开始做梦</p>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 3. 故事模式 (Story Mode) -->
        <transition name="fade">
            <div v-if="currentView === 'story'" class="absolute inset-0 z-30 flex flex-col bg-brand-bg">
                <!-- 图片显示区域 (上半部分) -->
                <div class="flex-1 w-full relative overflow-hidden bg-gray-100" :class="{'animate-shake': isShaking}">
                    <transition name="fade" mode="out-in">
                        <img :key="currentScene.image"
                             :src="currentScene.image || assets.defaultBg"
                             class="w-full h-full object-cover transition-transform duration-[20s] ease-linear transform scale-100 hover:scale-105"
                             :class="{'scale-110': isShaking}"
                             alt="Scene">
                    </transition>
                    <!-- 遮罩，让文字更清晰 -->
                    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-brand-bg to-transparent"></div>
                </div>

                <!-- 文字与选项区域 (下半部分) -->
                <div class="w-full min-h-[40%] bg-brand-bg relative z-10 rounded-t-3xl -mt-6 shadow-[0_-10px_40px_rgba(0,0,0,0.05)] safe-bottom flex flex-col">

                    <!-- 装饰线条 -->
                    <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mt-4 mb-2"></div>

                    <!-- 角色名 (如果有) -->
                    <div v-if="currentScene.speaker" class="px-6 pt-2">
                        <span class="inline-block px-3 py-1 rounded-lg text-xs font-bold bg-brand-highlight text-black shadow-sm">
                            {{ currentScene.speaker }}
                        </span>
                    </div>

                    <!-- 对话文字内容 -->
                    <div class="px-6 py-4 flex-grow relative" @click="nextDialogue">
                        <transition name="text-dissolve" mode="out-in">
                            <p :key="displayText"
                               class="text-lg leading-relaxed font-medium text-brand-dark cursor-pointer"
                               :class="{'text-2xl font-bold text-red-500': currentScene.isShouting}">
                                {{ displayText }}
                                <span v-if="isTyping" class="inline-block w-1 h-5 bg-brand-accent animate-pulse ml-1 align-middle"></span>
                            </p>
                        </transition>
                        <p class="text-xs text-brand-gray mt-4 opacity-50 absolute bottom-4 right-6">
                            {{ isTyping ? '...' : (currentScene.options ? '' : '点击继续 ▶') }}
                        </p>
                    </div>

                    <!-- 选项区域 -->
                    <div v-if="showOptions" class="px-6 pb-8 space-y-3 animate-fade-in">
                        <button v-for="(opt, index) in currentScene.options" :key="index"
                                @click="chooseOption(opt)"
                                class="w-full py-4 px-6 rounded-2xl bg-white border border-brand-accent/30 shadow-sm text-left font-medium text-brand-dark transition-all duration-200 hover:shadow-md hover:bg-brand-highlight hover:border-transparent active:scale-98 flex items-center justify-between group">
                            <span>{{ opt.text }}</span>
                            <i class="fa-solid fa-chevron-right text-xs opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        </button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 4. 微信模拟器 (WeChat) -->
        <transition name="fade">
            <div v-if="currentView === 'wechat'" class="absolute inset-0 z-30 flex flex-col bg-wx-bg">
                <!-- 顶栏 -->
                <div class="h-14 bg-wx-bg flex items-center px-4 border-b border-gray-200 shadow-sm sticky top-0 z-10 backdrop-blur-md bg-opacity-90">
                    <i class="fa-solid fa-chevron-left text-brand-dark mr-4"></i>
                    <span class="font-medium text-lg">钥匙老师 (CPU版)</span>
                    <i class="fa-solid fa-ellipsis text-brand-dark ml-auto"></i>
                </div>

                <!-- 聊天内容 -->
                <div class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar" id="chat-container">
                    <div v-for="(msg, index) in chatHistory" :key="index" class="flex w-full animate-pop" :class="msg.isMe ? 'justify-end' : 'justify-start'">
                        <!-- 对方头像 -->
                        <img v-if="!msg.isMe" :src="assets.teacherAvatar" class="w-10 h-10 rounded-lg mr-3 shadow-sm">

                        <!-- 气泡 -->
                        <div class="chat-bubble shadow-sm" :class="msg.isMe ? 'chat-me' : 'chat-other'">
                            {{ msg.content }}
                        </div>

                        <!-- 我方头像 -->
                        <img v-if="msg.isMe" :src="assets.avatar" class="w-10 h-10 rounded-lg ml-3 shadow-sm">
                    </div>

                    <div v-if="isChatTyping" class="text-xs text-gray-400 text-center animate-pulse">对方正在输入...</div>
                </div>

                <!-- 底部输入栏 (伪装) -->
                <div class="bg-gray-100 p-3 safe-bottom border-t border-gray-200">
                    <!-- 如果有选项，显示选项，否则显示伪输入框 -->
                    <div v-if="chatOptions.length > 0" class="space-y-2">
                        <button v-for="(opt, idx) in chatOptions" :key="idx"
                                @click="handleChatOption(opt)"
                                class="w-full py-3 bg-white rounded-lg text-brand-dark font-medium shadow-sm active:bg-gray-50 text-sm border border-gray-200">
                            {{ opt.text }}
                        </button>
                    </div>
                    <div v-else class="flex items-center space-x-3 bg-white p-2 rounded-lg">
                        <i class="fa-regular fa-keyboard text-gray-500 text-xl ml-1"></i>
                        <div class="flex-1 text-gray-300 text-sm">发消息...</div>
                        <i class="fa-regular fa-face-smile text-gray-500 text-xl"></i>
                        <i class="fa-solid fa-circle-plus text-gray-500 text-xl mr-1"></i>
                    </div>
                </div>
            </div>
        </transition>

        <!-- 5. 结局页面 (Ending) -->
        <transition name="fade">
            <div v-if="currentView === 'ending'" class="absolute inset-0 z-50 flex flex-col bg-brand-bg overflow-hidden">
                <div class="flex-1 flex flex-col items-center justify-center p-8 text-center relative z-10">
                    <div class="w-full max-w-md bg-white/50 backdrop-blur-xl rounded-3xl p-8 shadow-2xl border border-white/60 animate-pop">
                        <img :src="assets.happyBirthday" class="w-full rounded-xl mb-6 shadow-lg" alt="Birthday">
                        <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-400 to-pink-500 mb-4 animate-breath">
                            付QQ，生日快乐！
                        </h1>
                        <p class="text-gray-600 leading-relaxed">{{ endingText }}</p>
                    </div>

                    <button @click="restartGame" class="mt-12 px-8 py-3 bg-brand-dark text-white rounded-full font-bold shadow-lg hover:shadow-xl transition-transform active:scale-95">
                        再次做梦 <i class="fa-solid fa-rotate-right ml-2"></i>
                    </button>
                </div>
                <!-- 装饰背景 -->
                <div class="absolute top-0 left-0 w-64 h-64 bg-brand-highlight opacity-20 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"></div>
                <div class="absolute bottom-0 right-0 w-80 h-80 bg-brand-accent opacity-20 rounded-full blur-3xl translate-x-1/3 translate-y-1/3"></div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, reactive, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                // --- 资源配置 ---
                const repoBase = 'https://raw.githubusercontent.com/LOOTOOT/WorkingQQ/main/';
                const assets = {
                    avatar: repoBase + 'fqq-avtar.jpg',
                    defaultBg: repoBase + 'sleeping.png',
                    mainPage: repoBase + 'mainpage.jpg',
                    teacherAvatar: repoBase + 'img-left.jpg',
                    shock: repoBase + encodeURIComponent('我骟QQ彻底怒了.png'),
                    phone: repoBase + encodeURIComponent('付QQ接电话无语.png'),
                    god: repoBase + encodeURIComponent('付QQ神威大发.png'),
                    fight: repoBase + encodeURIComponent('付QQ战斗胜利结算画面.png'),
                    goldKey: repoBase + encodeURIComponent('付QQ脚踩金钥.png'),
                    dizzy: repoBase + encodeURIComponent('晕头转向电脑局.png'),
                    wakeUp: repoBase + encodeURIComponent('躺在床上睁眼的付QQ.png'),
                    happyBirthday: repoBase + 'FQQHappyBirthday.png',
                    bgm: repoBase + 'HappyBirthdaySong.mp3'
                };

                // --- 状态管理 ---
                const currentView = ref('login'); // login, main, story, wechat, ending
                const loginTextShow = ref(false);
                const isLoggingIn = ref(false);
                const loginSuccessInfo = ref(false);
                const isShaking = ref(false);
                const bgmAudio = ref(null);

                // 故事引擎
                const currentSceneId = ref('start');
                const displayText = ref('');
                const isTyping = ref(false);
                const showOptions = ref(false);

                // 微信引擎
                const chatHistory = ref([]);
                const chatOptions = ref([]);
                const isChatTyping = ref(false);
                const endingText = ref('');

                // --- 剧本数据 (Story Data) ---
                const storyNodes = {
                    'start': {
                        image: assets.defaultBg,
                        lines: [
                            "你是付QQ，23英语2班的班长。",
                            "AAA纯血正宗PPT大王AKA导员免费劳动力",
                            "现在是北京时间12月7日，早上8点20分\n你正在享受美好的周末"
                        ],
                        next: 'phone_ring'
                    },
                    'phone_ring': {
                        image: assets.defaultBg, // 应该震动
                        effect: 'shake',
                        isShouting: true,
                        lines: [
                            "一阵强劲的音乐袭来！",
                            "是你的QQ电话响了呢，你决定："
                        ],
                        options: [
                            { text: "A1. 谁啊？接一下吧", next: 'pick_up' },
                            { text: "B1. 都衮，没人能阻止我睡觉", next: 'sleep_more' }
                        ]
                    },
                    'sleep_more': {
                        // 直接跳结局
                        action: () => triggerEnding('sleep')
                    },
                    'pick_up': {
                        image: assets.phone,
                        speaker: "付QQ",
                        lines: [
                            "「喂，老师。」",
                            "手机传来你导员的声音...",
                            "「付QQ你现在做一个优秀班集体的PPT，下午4点前给我。」",
                            ".........什么玩意儿？做PPT？你："
                        ],
                        options: [
                            { text: "A2. 怒了，拒绝", next: 'angry' },
                            { text: "B2. 已老实，一会儿就去做", next: 'obedient' }
                        ]
                    },
                    'angry': {
                        image: assets.shock,
                        speaker: "内心",
                        lines: [
                            "大早上做什么PPT？你彻底怒了！",
                            "往日种种在眼前浮现，你忍无可忍，速速动手！",
                            "「你不会做PPT吗？自己搞啊！」"
                        ],
                        next: 'angry_response'
                    },
                    'angry_response': {
                        image: assets.shock,
                        speaker: "导员",
                        lines: ["手机传来导员低沉的声音：「付QQ你怎么和老师说话的？」"],
                        options: [
                            { text: "A3. 我现在就这个态度，不爱听别听", next: 'attitude_hard' },
                            { text: "B3. 对不起老师我刚刚没睡醒", next: 'obedient' } // 转回去
                        ]
                    },
                    'attitude_hard': {
                        image: assets.god,
                        speaker: "导员",
                        lines: [
                            "电话那头安静如鸡，随后是带着怒意的一声喊：「付QQ！」",
                            "你毫不示弱：「吼那么大声干嘛？现在是周末！我还在睡觉！」",
                            "导员：「你是班长，要有奉献精神！」"
                        ],
                        options: [
                            { text: "A4. 奉献精神？那你给我发工资了吗？", next: 'salary_talk' },
                            { text: "B4. 这班长谁爱当谁当，我不干了！", next: 'quit_talk' }
                        ]
                    },
                    'salary_talk': {
                        image: assets.goldKey,
                        speaker: "付QQ",
                        lines: [
                            "「你给我工资了吗要求这么多？我白干这么久还没找你算账呢！」",
                            "导员：「你怎么这么计较」",
                            "你乘胜追击：「计较？那我们现在就算算，我干了多少活，你该给我多少钱？」",
                            "导员：「好了，你先休息」...",
                            "「啪！」你直接挂了电话。"
                        ],
                        next: 'battle_win_salary'
                    },
                    'battle_win_salary': {
                        image: assets.fight,
                        lines: ["怼得你神清气爽，也不多啰嗦。"],
                        action: () => startWeChat('salary')
                    },
                    'quit_talk': {
                        image: assets.goldKey,
                        speaker: "付QQ",
                        lines: [
                            "「这班长谁爱当谁当！你现在就找别人，我立刻退出所有群！」",
                            "导员：「付QQ有话好好说」",
                            "「没什么好说的，我受够了。再见。」",
                            "「啪！」你干脆利落地挂了电话。"
                        ],
                        next: 'battle_win_quit'
                    },
                    'battle_win_quit': {
                        image: assets.fight,
                        lines: ["怼得你神清气爽，也不多啰嗦。"],
                        action: () => startWeChat('quit')
                    },
                    'obedient': {
                        image: assets.dizzy,
                        lines: [
                            "你叹了口气：「好的老师，我尽快做」",
                            "挂了电话，你打开电脑开始收集材料...",
                            "中午煮了火鸡面，你边吃边做。",
                            "下午3点发到老师邮箱，老师回复：‘下次要更主动些’",
                            "你苦笑一下，关掉电脑，躺回床上休息...",
                            "盯着天花板发呆..."
                        ],
                        action: () => triggerEnding('reality')
                    }
                };

                const currentScene = ref(storyNodes['start']);
                let currentLineIndex = 0;

                // --- 逻辑方法 ---

                // 1. 登录逻辑
                onMounted(() => {
                    // 初始动画序列
                    setTimeout(() => { loginTextShow.value = true; }, 500);
                    setTimeout(() => { loginTextShow.value = false; }, 2500);
                });

                const handleLogin = () => {
                    if(isLoggingIn.value) return;
                    isLoggingIn.value = true;
                    // 播放一个虚拟的音效可以通过创建短暂的 AudioContext oscillator，这里简化。
                    setTimeout(() => {
                        isLoggingIn.value = false; // 停止波纹
                        loginSuccessInfo.value = true;
                        setTimeout(() => {
                            currentView.value = 'main';
                        }, 1500);
                    }, 1000);
                };

                // 2. 开始游戏
                const startGame = () => {
                    currentView.value = 'story';
                    loadScene('start');
                    // 尝试播放背景音乐 (需要用户交互后)
                    // bgmAudio.value.play().catch(e => console.log('Audio autoplay blocked'));
                };

                // 3. 故事处理
                const loadScene = (sceneId) => {
                    currentSceneId.value = sceneId;
                    const scene = storyNodes[sceneId];
                    if(scene.action) {
                        scene.action();
                        return;
                    }
                    currentScene.value = scene;
                    currentLineIndex = 0;
                    showOptions.value = false;

                    if(scene.effect === 'shake') {
                        isShaking.value = true;
                        setTimeout(() => isShaking.value = false, 500);
                    }

                    typeNextLine();
                };

                const typeNextLine = () => {
                    if (currentLineIndex >= currentScene.value.lines.length) {
                        // 对话结束，检查是否有选项或下一幕
                        if (currentScene.value.options) {
                            showOptions.value = true;
                        } else if (currentScene.value.next) {
                            loadScene(currentScene.value.next);
                        }
                        return;
                    }

                    const line = currentScene.value.lines[currentLineIndex];
                    displayText.value = "";
                    isTyping.value = true;

                    let i = 0;
                    const speed = 40; // 打字速度
                    const typeWrapper = () => {
                        if (i < line.length) {
                            displayText.value += line.charAt(i);
                            i++;
                            setTimeout(typeWrapper, speed);
                        } else {
                            isTyping.value = false;
                            currentLineIndex++;
                        }
                    };
                    typeWrapper();
                };

                const nextDialogue = () => {
                    if (isTyping.value) {
                        // 如果正在打字，点击这直接显示全句
                        // (简化处理，这里直接不让点比较好实现，或者加速)
                        return;
                    }
                    if (showOptions.value) return; // 有选项时不能点
                    typeNextLine();
                };

                const chooseOption = (opt) => {
                    loadScene(opt.next);
                };

                // 4. 微信逻辑
                const startWeChat = (branch) => {
                    currentView.value = 'wechat';
                    chatHistory.value = [];

                    // 初始对话
                    addChatMsg("付QQ你怎么敢挂老师电话？", false);
                    setTimeout(() => {
                        addChatMsg("太不像话了！", false);

                        // 给出选项
                        chatOptions.value = [
                            { text: "A5. （继续输出）我就这样，怎么着？", type: 'A' },
                            { text: "B5. （无视）已读不回", type: 'B' }
                        ];
                    }, 1000);
                };

                const addChatMsg = (text, isMe) => {
                    chatHistory.value.push({ content: text, isMe });
                    nextTick(() => {
                        const container = document.getElementById('chat-container');
                        if(container) container.scrollTop = container.scrollHeight;
                    });
                };

                const handleChatOption = (opt) => {
                    chatOptions.value = []; // 清空选项
                    if(opt.type === 'A') {
                        // 猛人线继续输出
                        addChatMsg("不像话的是你吧？周末早上八点打电话让人做PPT？", true);
                        setTimeout(() => addChatMsg("你自己怎么不做？就知道使唤学生？", true), 1000);

                        setTimeout(() => {
                            isChatTyping.value = true;
                            setTimeout(() => {
                                isChatTyping.value = false;
                                addChatMsg("你这样态度有问题，我要跟你家长谈谈！", false);

                                setTimeout(() => {
                                    addChatMsg("谈啊，说我在学校被当免费劳动力", true);
                                    addChatMsg("你打啊，现在就打", true);

                                    // 撤回特效模拟
                                    setTimeout(() => {
                                        chatHistory.value.push({ content: '"对方已撤回一条消息"', isMe: false, isSystem: true }); // 这里简化样式直接用other
                                        setTimeout(() => {
                                            addChatMsg("算了，你冷静一下。PPT我找别人做。", false);
                                            setTimeout(() => triggerEnding('hero'), 2000);
                                        }, 1000);
                                    }, 3000);
                                }, 1500);
                            }, 1500);
                        }, 2000);
                    } else {
                        // 这里的处理：已读不回
                        setTimeout(() => {
                            addChatMsg("？", false);
                            setTimeout(() => {
                                addChatMsg("付QQ，看到回复。", false);
                                setTimeout(() => {
                                    // 模拟十分钟后
                                    addChatMsg("行，你厉害。PPT不用你做了。", false);
                                    setTimeout(() => triggerEnding('quiet'), 2000);
                                }, 2000); // 缩短时间方便演示
                            }, 1000);
                        }, 2000);
                    }
                };

                // 5. 结局逻辑
                const triggerEnding = (type) => {
                    currentView.value = 'ending';
                    // 播放音乐
                    const audio = document.querySelector('audio');
                    if(audio) audio.play();

                    if (type === 'sleep') {
                        endingText.value = "你舒服地翻了个身，沉沉睡去。再次醒来，已经是中午。阳光明媚，周末大好。没有电话，没有PPT，只有惬意的休息。";
                    } else if (type === 'hero' || type === 'quiet') {
                        endingText.value = "你猛地睁开眼睛。阳光从窗帘缝隙洒进来，宿舍里安安静静。原来……是一场梦啊。但不得不说，骂得真爽。虽然梦是假的，但爽是真的。";
                    } else {
                        // reality
                        endingText.value = "你盯着熟悉的帘子。手机安静地躺在枕边。没有电话，没有PPT。原来……是一场梦啊。虽然在梦里也被CPU了，但那都是假的。嘿，今天是你生日，开心一点吧。";
                    }

                    // 撒花
                    const duration = 5000;
                    const end = Date.now() + duration;

                    (function frame() {
                        confetti({
                            particleCount: 5,
                            angle: 60,
                            spread: 55,
                            origin: { x: 0 },
                            colors: ['#D8F878', '#FFCCB6', '#FFF']
                        });
                        confetti({
                            particleCount: 5,
                            angle: 120,
                            spread: 55,
                            origin: { x: 1 },
                            colors: ['#D8F878', '#FFCCB6', '#FFF']
                        });

                        if (Date.now() < end) {
                            requestAnimationFrame(frame);
                        }
                    }());
                };

                const restartGame = () => {
                    location.reload();
                };

                return {
                    assets,
                    currentView,
                    loginTextShow,
                    isLoggingIn,
                    loginSuccessInfo,
                    isShaking,

                    // Story
                    currentScene,
                    displayText,
                    isTyping,
                    showOptions,
                    nextDialogue,
                    chooseOption,
                    startGame,
                    handleLogin,

                    // WeChat
                    chatHistory,
                    chatOptions,
                    isChatTyping,
                    handleChatOption,

                    // Ending
                    endingText,
                    restartGame
                }
            }
        }).mount('#app');
    </script>
</body>
</html>