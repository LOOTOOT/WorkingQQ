<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>付QQ的最终幻想</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/preline/dist/preline.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            bg: '#FFFBF8',      // 主背景
                            secondary: '#FFCCB6', // 次要/点缀
                            accent: '#D8F878',    // 强调色
                            dark: '#2c2c2c',
                            wechat: '#95EC69',
                            wechat_white: '#ffffff'
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', '"Segoe UI"', 'Roboto', '"Helvetica Neue"', 'Arial', '"Noto Sans SC"', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.8s ease-out forwards',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* 全局样式覆盖 */
        body {
            background-color: #FFFBF8;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* 隐藏滚动条但允许滚动 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* 玻璃拟态卡片 */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        /* 按钮微交互 */
        .btn-interact {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-interact:active {
            transform: scale(0.95);
        }

        /* 打字机光标 */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* 波纹特效 */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(216, 248, 120, 0.6);
            transform: scale(0);
            animation: ripple-anim 0.6s linear;
            pointer-events: none;
        }
        @keyframes ripple-anim {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* 微信聊天气泡箭头 */
        .chat-bubble-left::before {
            content: "";
            position: absolute;
            left: -6px;
            top: 14px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-right: 6px solid #FFF;
        }
        .chat-bubble-right::before {
            content: "";
            position: absolute;
            right: -6px;
            top: 14px;
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 6px solid #95EC69;
        }

        /* 场景切换过渡 */
        .scene {
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .scene.active {
            display: flex; /* 或 block，视具体元素而定 */
            opacity: 1;
        }
    </style>
</head>
<body class="h-screen w-screen relative overflow-hidden font-sans text-gray-800">

    <div class="fixed top-[-10%] right-[-10%] w-64 h-64 bg-brand-secondary/20 rounded-full blur-3xl pointer-events-none"></div>
    <div class="fixed bottom-[-10%] left-[-10%] w-80 h-80 bg-brand-accent/20 rounded-full blur-3xl pointer-events-none"></div>

    <audio id="bgm" loop>
        <source src="HappyBirthdaySong.mp3" type="audio/mpeg">
        </audio>

    <section id="scene-login" class="scene active flex-col items-center justify-center h-full w-full z-10">
        <div id="login-text" class="text-xl text-gray-500 mb-8 font-light tracking-widest opacity-0 transition-opacity duration-1000">请登录</div>
        
        <div class="relative group cursor-pointer" onclick="handleLogin(this)">
            <div class="absolute -inset-1 bg-gradient-to-r from-brand-secondary to-brand-accent rounded-full opacity-25 group-hover:opacity-75 blur transition duration-1000 group-hover:duration-200"></div>
            <div class="relative w-28 h-28 rounded-full overflow-hidden border-4 border-white shadow-xl transform transition duration-500 hover:scale-105">
                <img src="https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/fqq-avtar.jpg" 
                     onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Felix'" 
                     class="w-full h-full object-cover" alt="Avatar">
            </div>
            <div class="text-center mt-4 font-bold text-lg text-gray-700">付QQ</div>
        </div>

        <div id="login-success" class="absolute bottom-20 text-brand-accent font-bold text-2xl tracking-widest opacity-0 transform translate-y-4 transition-all duration-500">
            登入成功
        </div>
    </section>

    <section id="scene-main" class="scene h-full w-full relative z-10 flex-col">
        <div class="absolute inset-0 z-0">
            <img src="https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/mainpage.jpg" 
                 onerror="this.src='https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1000&auto=format&fit=crop'"
                 class="w-full h-full object-cover brightness-90" alt="Main Page">
            <div class="absolute inset-0 bg-gradient-to-t from-brand-bg/90 via-transparent to-transparent"></div>
        </div>

        <div class="absolute bottom-24 w-full text-center z-20 cursor-pointer" onclick="startGame()">
            <p class="text-brand-secondary font-medium tracking-[0.2em] animate-pulse text-lg drop-shadow-md">
                点击任意地方开始做梦
            </p>
        </div>
    </section>

    <section id="scene-story" class="scene h-full w-full relative z-10 flex-col bg-brand-bg">
        <div class="h-1/2 w-full relative overflow-hidden bg-gray-100">
            <img id="story-image" src="" class="w-full h-full object-cover transition-all duration-700 ease-in-out" alt="Story Image">
            <div id="shake-layer" class="absolute inset-0 pointer-events-none"></div>
        </div>

        <div class="h-1/2 w-full px-6 py-8 flex flex-col justify-between relative -mt-6 bg-brand-bg rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.05)] z-20">
            
            <div class="w-12 h-1 bg-gray-200 rounded-full mx-auto mb-6"></div>

            <div id="story-text-container" class="flex-grow overflow-y-auto no-scrollbar mb-4">
                <p id="story-text" class="text-lg leading-loose text-gray-700 font-medium"></p>
            </div>

            <div id="story-choices" class="space-y-3 w-full pb-4">
                </div>
        </div>
    </section>

    <section id="scene-wechat" class="scene h-full w-full flex-col bg-[#EDEDED] z-10">
        <div class="h-14 bg-[#EDEDED] border-b border-gray-300 flex items-center justify-between px-4 sticky top-0 z-50">
            <div class="flex items-center text-gray-800">
                <i class="fas fa-chevron-left text-lg mr-4"></i>
                <span class="font-medium text-lg">钥匙老师 (导员CPU版)</span>
            </div>
            <i class="fas fa-ellipsis-h text-gray-800"></i>
        </div>

        <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
            </div>

        <div class="h-14 bg-[#F7F7F7] border-t border-gray-300 flex items-center px-3 gap-3">
            <i class="far fa-keyboard text-gray-600 text-2xl"></i>
            <div class="flex-1 h-9 bg-white rounded flex items-center px-2">
                <span class="text-gray-300 text-sm">按住 说话</span>
            </div>
            <i class="far fa-smile text-gray-600 text-2xl"></i>
            <i class="fas fa-plus-circle text-gray-600 text-2xl"></i>
        </div>
    </section>

    <section id="scene-ending" class="scene h-full w-full flex-col items-center justify-center bg-black z-30 transition-colors duration-1000">
        
        <div id="ending-content" class="text-center px-6 opacity-0 transition-opacity duration-1000 relative z-20">
            <div class="w-48 h-48 mx-auto mb-8 rounded-full overflow-hidden border-4 border-brand-accent shadow-2xl">
                <img src="https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/fqq-avtar.jpg" 
                     onerror="this.src='https://api.dicebear.com/7.x/avataaars/svg?seed=Felix'" 
                     class="w-full h-full object-cover">
            </div>
            <h1 class="text-3xl font-bold text-brand-secondary mb-4 drop-shadow-lg">付QQ<br>生日快乐！</h1>
            <p id="ending-text" class="text-white/80 leading-relaxed text-lg"></p>
        </div>

        <canvas id="confetti" class="absolute inset-0 pointer-events-none z-10"></canvas>
    </section>

    <script>
        // --- 资源配置 ---
        const ASSETS = {
            avatar: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/fqq-avtar.jpg",
            imgLeft: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/img-left.jpg",
            mainPage: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/mainpage.jpg",
            sleeping: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/sleeping.png",
            speechless: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/付QQ接电话无语.png",
            angry: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/我骟QQ彻底怒了.png",
            power: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/付QQ神威大发.png",
            kick: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/付QQ脚踩金钥.png",
            win: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/付QQ战斗胜利结算画面.png",
            dizzy: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/晕头转向电脑局.png",
            wakeup: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/躺在床上睁眼的付QQ.png",
            hbd: "https://cdn.jsdelivr.net/gh/LOOTOOT/WorkingQQ@main/付QQHappyBirthday.png"
        };

        // 默认占位图，防止加载失败
        const PLACEHOLDER_IMG = "https://images.unsplash.com/photo-1579546929518-9e396f3cc809?q=80&w=1000&auto=format&fit=crop";

        const bgm = document.getElementById('bgm');
        let currentBranch = ''; // 记录分支 'lazy' or 'brave'
        
        // --- 场景管理 ---
        function switchScene(id) {
            document.querySelectorAll('.scene').forEach(el => {
                el.classList.remove('active', 'flex');
                setTimeout(() => {
                    if(!el.classList.contains('active')) el.style.display = 'none';
                }, 500);
            });
            const target = document.getElementById(id);
            target.style.display = 'flex';
            // 强制重绘
            void target.offsetWidth; 
            target.classList.add('active');
        }

        // --- 1. 登录逻辑 ---
        window.onload = () => {
            setTimeout(() => {
                const txt = document.getElementById('login-text');
                txt.classList.remove('opacity-0');
                txt.classList.add('typing-cursor');
                setTimeout(() => {
                    txt.classList.remove('typing-cursor');
                    txt.classList.add('opacity-0');
                }, 2000);
            }, 500);
        };

        function handleLogin(el) {
            // 播放音乐（此时由于有交互，浏览器允许播放）
            bgm.volume = 0.3;
            bgm.play().catch(e => console.log("Audio play failed interaction required"));

            // 视觉特效
            const rect = el.getBoundingClientRect();
            const ripple = document.createElement('div');
            ripple.className = 'ripple';
            ripple.style.width = ripple.style.height = '100px';
            ripple.style.left = '50%';
            ripple.style.top = '50%';
            ripple.style.transform = 'translate(-50%, -50%) scale(0)';
            el.appendChild(ripple);

            // 闪光
            el.querySelector('img').classList.add('brightness-150', 'scale-110');

            setTimeout(() => {
                el.style.opacity = '0';
                document.getElementById('login-success').classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => {
                    switchScene('scene-main');
                }, 1500);
            }, 600);
        }

        function startGame() {
            switchScene('scene-story');
            runStoryNode('start');
        }

        // --- 2. 故事引擎 ---
        const storyScript = {
            'start': {
                img: ASSETS.sleeping,
                sequence: [
                    "你是付QQ，23英语2班的班长。",
                    "AAA纯血正宗PPT大王AKA导员免费劳动力",
                    "现在是北京时间12月7日，早上8点20分\n你正在享受美好的周末",
                    { text: "一阵强劲的音乐袭来！", effect: "shake", bold: true },
                    "是你的QQ电话响了呢，你决定"
                ],
                choices: [
                    { text: "谁啊？接一下吧", next: "b_answer" },
                    { text: "都衮，没人能阻止我睡觉", next: "end_sleep" }
                ]
            },
            'b_answer': {
                img: ASSETS.speechless,
                sequence: [
                    "「喂，老师。」",
                    "手机传来你导员的声音",
                    "「付QQ你现在做一个优秀班集体的PPT，下午4点前给我。」",
                    "………什么玩意儿？做PPT？你..."
                ],
                choices: [
                    { text: "怒了，拒绝", next: "c_angry" },
                    { text: "已老实，一会儿就去做", next: "d_coward" }
                ]
            },
            'c_angry': {
                img: ASSETS.angry,
                sequence: [
                    "大早上做什么PPT？你彻底怒了",
                    "往日种种在眼前浮现，你忍无可忍，速速动手",
                    { text: "「你不会做PPT吗？自己搞啊」", bold: true, color: "#ef4444" },
                    "手机传来导员低沉的声音：「付QQ你怎么和老师说话的？」"
                ],
                choices: [
                    { text: "我现在就这个态度，不爱听别听", next: "a3_rude" },
                    { text: "对不起老师我刚刚没睡醒", next: "d_coward" } // B3 -> D
                ]
            },
            'a3_rude': {
                img: ASSETS.power,
                sequence: [
                    "电话那头安静如鸡，随后是带着怒意的一声喊：「付QQ！」",
                    "你毫不示弱：「吼那么大声干嘛？现在是周末！我还在睡觉！」",
                    "导员：「你是班长，要有奉献精神！」"
                ],
                choices: [
                    { text: "奉献精神？那你给我发工资了吗？", next: "a4_salary" },
                    { text: "这班长谁爱当谁当，我不干了！", next: "b4_quit" }
                ]
            },
            'a4_salary': {
                img: ASSETS.kick,
                sequence: [
                    "「你给我工资了吗要求这么多？我白干这么久还没找你算账呢！」",
                    "导员：「你怎么这么计较」",
                    "你乘胜追击：「计较？那我们现在就算算，我干了多少活，你该给我多少钱？」",
                    "导员：「好了，你先休息」",
                    "「啪！」你直接挂了电话。"
                ],
                nextScene: 'wechat',
                nextParams: 'salary'
            },
            'b4_quit': {
                img: ASSETS.kick,
                sequence: [
                    "「这班长谁爱当谁当！你现在就找别人，我立刻退出所有群！」",
                    "导员：「付QQ有话好好说」",
                    "「没什么好说的，我受够了。再见。」",
                    "「啪！」你干脆利落地挂了电话。"
                ],
                nextScene: 'wechat',
                nextParams: 'quit'
            },
            'd_coward': {
                img: ASSETS.dizzy,
                sequence: [
                    "你叹了口气：「好的老师，我尽快做」",
                    "挂了电话，你打开电脑开始收集材料",
                    "中午煮了火鸡面，你边吃边做",
                    "下午3点发到老师邮箱",
                    "老师回复：‘下次要更主动些’",
                    "你苦笑一下，关掉电脑",
                    "躺回床上休息...",
                    "盯着天花板发呆..."
                ],
                nextScene: 'end_reality'
            },
            'wechat_win': {
                 // 仅仅用于胜利结算图展示，作为过渡
                 img: ASSETS.win,
                 sequence: ["怼得你神清气爽，也不多啰嗦。"],
                 nextScene: 'wechat'
            }
        };

        // 渲染故事
        let currentSequenceIndex = 0;
        let currentNodeData = null;

        function runStoryNode(nodeId) {
            currentNodeData = storyScript[nodeId];
            currentSequenceIndex = 0;
            
            // 特殊跳转逻辑
            if(nodeId === 'end_sleep') {
                runEnding('sleep');
                return;
            }
            if(nodeId === 'end_reality') {
                runEnding('reality');
                return;
            }

            // 更新图片
            const imgEl = document.getElementById('story-image');
            imgEl.style.opacity = 0;
            setTimeout(() => {
                imgEl.src = currentNodeData.img || PLACEHOLDER_IMG;
                imgEl.onload = () => { imgEl.style.opacity = 1; }
                imgEl.onerror = () => { imgEl.src = PLACEHOLDER_IMG; imgEl.style.opacity = 1; }
            }, 300);

            // 清空选项
            document.getElementById('story-choices').innerHTML = '';
            
            showNextSequence();
        }

        function showNextSequence() {
            const container = document.getElementById('story-text-container');
            const txtEl = document.getElementById('story-text');
            
            if (currentSequenceIndex >= currentNodeData.sequence.length) {
                // 序列结束，显示选项或跳转
                if (currentNodeData.choices) {
                    showChoices(currentNodeData.choices);
                } else if (currentNodeData.nextScene) {
                    if(currentNodeData.nextScene === 'wechat') {
                        // 在进入微信前显示胜利画面（如果是A4/B4）
                        const winImg = ASSETS.win;
                        const imgEl = document.getElementById('story-image');
                        imgEl.src = winImg;
                        txtEl.innerText = "怼得你神清气爽，也不多啰嗦。";
                        // 添加一个继续按钮
                        const btn = document.createElement('button');
                        btn.className = "w-full py-4 bg-gradient-to-r from-brand-secondary to-brand-accent text-brand-dark font-bold rounded-2xl shadow-lg btn-interact";
                        btn.innerText = "打开微信";
                        btn.onclick = () => initWechat(currentNodeData.nextParams);
                        document.getElementById('story-choices').appendChild(btn);
                    } else {
                        switchScene(currentNodeData.nextScene);
                    }
                }
                return;
            }

            // 获取当前文本内容
            let content = currentNodeData.sequence[currentSequenceIndex];
            let textStr = "";
            let isShake = false;

            if (typeof content === 'object') {
                textStr = content.text;
                if(content.effect === 'shake') isShake = true;
                if(content.bold) txtEl.classList.add('font-bold', 'text-xl');
                else txtEl.classList.remove('font-bold', 'text-xl');
                if(content.color) txtEl.style.color = content.color;
                else txtEl.style.color = '#333';
            } else {
                textStr = content;
                txtEl.classList.remove('font-bold', 'text-xl');
                txtEl.style.color = '#333';
            }

            // 动画
            txtEl.style.opacity = 0;
            txtEl.innerText = textStr;
            
            if(isShake) {
                document.body.classList.add('animate-shake');
                setTimeout(()=>document.body.classList.remove('animate-shake'), 500);
            }

            // 粒子消散模拟 (Fade In)
            setTimeout(() => {
                txtEl.style.opacity = 1;
                txtEl.classList.add('animate-fade-in');
            }, 100);

            // 自动或点击进入下一句
            currentSequenceIndex++;
            
            // 创建"点击继续"的隐形遮罩，或者等待用户点击屏幕任意位置
            // 这里为了简单，我们生成一个临时的透明覆盖层点击继续，或者直接3秒后继续?
            // 还是做成点击屏幕继续比较好
            const nextHandler = () => {
                document.removeEventListener('click', nextHandler);
                showNextSequence();
            };
            // 延迟一点绑定避免连点
            setTimeout(() => {
                document.addEventListener('click', nextHandler);
            }, 500);
        }

        function showChoices(choices) {
            const container = document.getElementById('story-choices');
            container.innerHTML = '';
            choices.forEach(c => {
                const btn = document.createElement('button');
                btn.className = "w-full py-4 bg-white/80 backdrop-blur border border-brand-secondary text-brand-dark font-semibold rounded-2xl shadow-sm hover:bg-brand-secondary hover:text-white transition-all duration-300 btn-interact mb-2";
                btn.innerText = c.text;
                btn.onclick = (e) => {
                    e.stopPropagation(); // 防止触发sequence点击
                    runStoryNode(c.next);
                };
                container.appendChild(btn);
            });
        }

        // --- 3. 微信逻辑 ---
        function initWechat(type) {
            switchScene('scene-wechat');
            const chatBox = document.getElementById('chat-container');
            chatBox.innerHTML = ''; // 清空

            // 预设对话
            const teacherAvatar = ASSETS.imgLeft; // 老师头像
            const myAvatar = ASSETS.avatar; // 我头像

            // 工具函数：发消息
            const addMsg = (text, isMe, delay) => {
                setTimeout(() => {
                    const row = document.createElement('div');
                    row.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
                    
                    const avatar = `<img src="${isMe ? myAvatar : teacherAvatar}" class="w-10 h-10 rounded shadow-md flex-shrink-0">`;
                    const bubble = `
                        <div class="relative max-w-[70%] px-4 py-2 rounded-md shadow-sm text-base 
                                    ${isMe ? 'bg-[#95EC69] mr-3 chat-bubble-right' : 'bg-white ml-3 chat-bubble-left'}">
                            ${text}
                        </div>
                    `;

                    row.innerHTML = isMe ? (bubble + avatar) : (avatar + bubble);
                    chatBox.appendChild(row);
                    chatBox.scrollTop = chatBox.scrollHeight;
                }, delay);
            };

            // 初始对话
            addMsg("付QQ你怎么敢挂老师电话？", false, 500);
            addMsg("太不像话了！", false, 1500);

            // 选项出现
            setTimeout(() => {
                const choiceDiv = document.createElement('div');
                choiceDiv.className = "fixed bottom-16 left-0 w-full px-4 space-y-2 z-50";
                choiceDiv.innerHTML = `
                    <button id="wx-a" class="w-full py-3 bg-brand-accent text-brand-dark rounded-xl shadow-lg font-bold">（继续输出）我就这样，怎么着？</button>
                    <button id="wx-b" class="w-full py-3 bg-gray-200 text-gray-600 rounded-xl shadow-lg font-bold">（无视）已读不回</button>
                `;
                document.getElementById('scene-wechat').appendChild(choiceDiv);

                document.getElementById('wx-a').onclick = () => {
                    choiceDiv.remove();
                    // 猛人输出流程
                    addMsg("不像话的是你吧？周末早上八点打电话让人做PPT？", true, 0);
                    addMsg("你自己怎么不做？就知道使唤学生？", true, 1000);
                    
                    setTimeout(() => {
                         addMsg("你这样态度有问题，我要跟你家长谈谈！", false, 1000);
                         setTimeout(() => {
                             addMsg("谈啊，说我在学校被当免费劳动力", true, 500);
                             addMsg("你打啊，现在就打", true, 1500);
                             
                             // 撤回特效
                             setTimeout(() => {
                                 const sysMsg = document.createElement('div');
                                 sysMsg.className = "text-center text-xs text-gray-400 my-2";
                                 sysMsg.innerText = "对方已撤回一条消息";
                                 chatBox.appendChild(sysMsg);
                                 chatBox.scrollTop = chatBox.scrollHeight;
                                 
                                 addMsg("算了，你冷静一下。PPT我找别人做。", false, 1000);
                                 setTimeout(() => runEnding('hero'), 3000);
                             }, 3000);
                         }, 2500);
                    }, 2500);
                };

                document.getElementById('wx-b').onclick = () => {
                    choiceDiv.remove();
                    // 冷暴力流程
                    addMsg("？", false, 1000);
                    addMsg("付QQ，看到回复。", false, 2000);
                    
                    setTimeout(() => {
                        const timeMsg = document.createElement('div');
                        timeMsg.className = "text-center text-xs text-gray-400 my-4";
                        timeMsg.innerText = "10:30";
                        chatBox.appendChild(timeMsg);
                        
                        addMsg("行，你厉害。PPT不用你做了。", false, 500);
                        setTimeout(() => runEnding('hero'), 3000);
                    }, 4000);
                };

            }, 2500);
        }

        // --- 4. 结局逻辑 ---
        function runEnding(type) {
            switchScene('scene-ending');
            const bg = document.getElementById('scene-ending');
            const txt = document.getElementById('ending-text');
            const content = document.getElementById('ending-content');

            // 初始黑屏
            bg.style.backgroundColor = 'black';
            content.style.opacity = 0;

            let story = "";
            let showConfetti = true;

            if (type === 'hero') {
                story = `你猛地睁开眼睛。<br>阳光从窗帘缝隙洒进来，宿舍里安安静静。<br>原来……是一场梦啊。<br>但不得不说，骂得真爽。<br><br>虽然梦是假的，但爽是真的。<br>今天是12月7日——`;
            } else if (type === 'sleep') {
                story = `你舒服地翻了个身，沉沉睡去。<br>再次醒来，已经是中午。<br>阳光明媚，周末大好。<br>没有电话，没有PPT，只有惬意的休息。<br><br>今天是12月7日——`;
            } else {
                // Reality
                story = `你盯着熟悉的帘子。<br>手机安静地躺在枕边。<br>没有电话，没有PPT。<br>原来……是一场梦啊。<br>虽然在梦里也被CPU了，但那都是假的。<br><br>嘿，今天是你生日，开心一点吧。`;
            }

            txt.innerHTML = story;

            setTimeout(() => {
                // 亮起
                if(type === 'reality') {
                    bg.style.backgroundColor = '#FFFBF8'; // 回到温馨色
                    txt.style.color = '#555';
                    document.querySelector('#scene-ending h1').classList.remove('text-brand-secondary');
                    document.querySelector('#scene-ending h1').classList.add('text-brand-accent');
                } else {
                    bg.style.backgroundColor = '#2c2c2c'; // 稍微亮一点的黑
                }
                
                content.style.opacity = 1;
                
                // 撒花 & 音乐高潮
                startConfetti();
                
            }, 2000);
        }

        // --- 简单的烟花 Canvas ---
        function startConfetti() {
            const canvas = document.getElementById("confetti");
            const ctx = canvas.getContext("2d");
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            let particles = [];
            const colors = ['#D8F878', '#FFCCB6', '#FFF', '#FFD700'];

            function Particle() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height - canvas.height;
                this.w = Math.random() * 10 + 5;
                this.h = Math.random() * 10 + 5;
                this.color = colors[Math.floor(Math.random() * colors.length)];
                this.speed = Math.random() * 3 + 2;
                this.angle = Math.random() * 360;
                this.spin = Math.random() < 0.5 ? -1 : 1;
            }

            Particle.prototype.update = function() {
                this.y += this.speed;
                this.angle += this.spin;
                if (this.y > canvas.height) {
                    this.y = -20;
                    this.x = Math.random() * canvas.width;
                }
            };

            Particle.prototype.draw = function() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle * Math.PI / 180);
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.w / 2, -this.h / 2, this.w, this.h);
                ctx.restore();
            };

            for (let i = 0; i < 100; i++) {
                particles.push(new Particle());
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => {
                    p.update();
                    p.draw();
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

    </script>
</body>
</html>